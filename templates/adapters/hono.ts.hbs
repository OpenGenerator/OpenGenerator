/**
 * Hono Server
 * Generated by OpenGenerator
 */

import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { compress } from 'hono/compress'
import { logger } from 'hono/logger'
import { secureHeaders } from 'hono/secure-headers'
import { prettyJSON } from 'hono/pretty-json'
{{#if rateLimit}}
import { rateLimiter } from 'hono-rate-limiter'
{{/if}}
{{#if auth}}
import { jwt } from 'hono/jwt'
{{/if}}

// Import routes
{{#each entities}}
import { {{camelCase name}}Routes } from './{{kebabCase name}}/{{kebabCase name}}.routes'
{{/each}}

// Types
{{#if auth}}
type Variables = {
  user: {
    id: string
    email: string
    [key: string]: unknown
  }
}
{{/if}}

const app = new Hono{{#if auth}}<{ Variables: Variables }>{{/if}}()

// Middleware
app.use('*', secureHeaders())
app.use('*', cors({
  origin: process.env.CORS_ORIGIN || '*',
  credentials: true,
}))
app.use('*', compress())
{{#if logging}}
app.use('*', logger())
{{/if}}
app.use('*', prettyJSON())

{{#if rateLimit}}
// Rate limiting
app.use('{{apiPrefix}}/*', rateLimiter({
  windowMs: {{rateLimit.windowMs}},
  limit: {{rateLimit.max}},
  keyGenerator: (c) => c.req.header('x-forwarded-for') || 'unknown',
}))
{{/if}}

{{#if auth}}
// JWT authentication for protected routes
app.use('{{apiPrefix}}/*', jwt({
  secret: process.env.JWT_SECRET!,
}))
{{/if}}

// Health check
app.get('/health', (c) => c.json({
  status: 'ok',
  timestamp: new Date().toISOString(),
}))

// Mount routes
{{#each entities}}
app.route('{{../apiPrefix}}/{{pluralize (kebabCase name)}}', {{camelCase name}}Routes)
{{/each}}

// 404 handler
app.notFound((c) => c.json({ error: 'Not found', code: 'NOT_FOUND' }, 404))

// Error handler
app.onError((err, c) => {
  console.error(err)
  return c.json({
    error: err.message || 'Internal server error',
    code: 'INTERNAL_ERROR',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack }),
  }, 500)
})

export { app }

// Export for different runtimes
export default {
  port: process.env.PORT || {{port}},
  fetch: app.fetch,
}
