/**
 * Fastify Server
 * Generated by OpenGenerator
 */

import Fastify from 'fastify'
import cors from '@fastify/cors'
import helmet from '@fastify/helmet'
import compress from '@fastify/compress'
import rateLimit from '@fastify/rate-limit'
{{#if swagger}}
import swagger from '@fastify/swagger'
import swaggerUi from '@fastify/swagger-ui'
{{/if}}
{{#if auth}}
import { authPlugin } from './plugins/auth'
{{/if}}

// Import routes
{{#each entities}}
import { {{camelCase name}}Routes } from './{{kebabCase name}}/{{kebabCase name}}.routes'
{{/each}}

const fastify = Fastify({
  logger: {{#if logging}}true{{else}}false{{/if}},
  trustProxy: true,
})

async function buildServer() {
  // Security
  await fastify.register(helmet, {
    contentSecurityPolicy: {{#if graphql}}false{{else}}true{{/if}},
  })

  await fastify.register(cors, {
    origin: process.env.CORS_ORIGIN || true,
    credentials: true,
  })

  // Compression
  await fastify.register(compress)

  {{#if rateLimit}}
  // Rate limiting
  await fastify.register(rateLimit, {
    max: {{rateLimit.max}},
    timeWindow: '{{rateLimit.timeWindow}}',
  })
  {{/if}}

  {{#if swagger}}
  // Swagger documentation
  await fastify.register(swagger, {
    openapi: {
      info: {
        title: '{{projectName}} API',
        version: '{{version}}',
        description: '{{description}}',
      },
      servers: [
        { url: process.env.API_URL || 'http://localhost:{{port}}' },
      ],
      {{#if auth}}
      components: {
        securitySchemes: {
          bearerAuth: {
            type: 'http',
            scheme: 'bearer',
            bearerFormat: 'JWT',
          },
        },
      },
      {{/if}}
    },
  })

  await fastify.register(swaggerUi, {
    routePrefix: '/docs',
  })
  {{/if}}

  {{#if auth}}
  // Auth plugin
  await fastify.register(authPlugin)
  {{/if}}

  // Health check
  fastify.get('/health', async () => ({
    status: 'ok',
    timestamp: new Date().toISOString(),
  }))

  // Register routes
  {{#each entities}}
  await fastify.register({{camelCase name}}Routes, { prefix: '{{../apiPrefix}}/{{pluralize (kebabCase name)}}' })
  {{/each}}

  // Error handler
  fastify.setErrorHandler((error, request, reply) => {
    fastify.log.error(error)

    const statusCode = error.statusCode || 500
    reply.status(statusCode).send({
      error: error.message,
      code: error.code || 'INTERNAL_ERROR',
      ...(process.env.NODE_ENV === 'development' && { stack: error.stack }),
    })
  })

  return fastify
}

export { buildServer }

// Start server if run directly
if (require.main === module) {
  buildServer().then((server) => {
    const port = process.env.PORT || {{port}}
    server.listen({ port: Number(port), host: '0.0.0.0' }, (err) => {
      if (err) {
        console.error(err)
        process.exit(1)
      }
    })
  })
}
