/**
 * Express Server
 * Generated by OpenGenerator
 */

import express from 'express'
import cors from 'cors'
import helmet from 'helmet'
import compression from 'compression'
import { createErrorHandler } from './errors'
{{#if auth}}
import { authMiddleware } from './middleware/auth'
{{/if}}
{{#if rateLimit}}
import { rateLimitMiddleware } from './middleware/rate-limit'
{{/if}}
{{#if logging}}
import { requestLogger } from './middleware/logger'
{{/if}}

// Import routers
{{#each entities}}
import { {{camelCase name}}Router } from './{{kebabCase name}}/{{kebabCase name}}.router'
{{/each}}

const app = express()

// Security middleware
app.use(helmet())
app.use(cors({
  origin: process.env.CORS_ORIGIN || '*',
  credentials: true,
}))

// Body parsing
app.use(express.json({ limit: '{{bodyLimit}}' }))
app.use(express.urlencoded({ extended: true }))

// Compression
app.use(compression())

{{#if logging}}
// Request logging
app.use(requestLogger())
{{/if}}

{{#if rateLimit}}
// Rate limiting
app.use(rateLimitMiddleware({
  windowMs: {{rateLimit.windowMs}},
  max: {{rateLimit.max}},
}))
{{/if}}

// Health check
app.get('/health', (_req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() })
})

// API routes
const apiPrefix = '{{apiPrefix}}'
{{#each entities}}
app.use(`${apiPrefix}/{{pluralize (kebabCase name)}}`, {{camelCase name}}Router)
{{/each}}

// 404 handler
app.use((_req, res) => {
  res.status(404).json({ error: 'Not found', code: 'NOT_FOUND' })
})

// Error handler
app.use(createErrorHandler())

export { app }

// Start server if run directly
if (require.main === module) {
  const port = process.env.PORT || {{port}}
  app.listen(port, () => {
    console.log(`Server running on port ${port}`)
  })
}
