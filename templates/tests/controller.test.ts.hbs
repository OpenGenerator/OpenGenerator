/**
 * {{pascalCase name}} Controller Tests
 * Generated by OpenGenerator
 */

import { describe, it, expect, beforeEach, vi } from 'vitest'
import request from 'supertest'
import express from 'express'
import { {{camelCase name}}Router } from '../src/{{kebabCase name}}/{{kebabCase name}}.router'

// Mock service
vi.mock('../src/{{kebabCase name}}/{{kebabCase name}}.service', () => ({
  {{pascalCase name}}Service: vi.fn().mockImplementation(() => ({
    findAll: vi.fn(),
    findById: vi.fn(),
    create: vi.fn(),
    update: vi.fn(),
    delete: vi.fn(),
  })),
}))

import { {{pascalCase name}}Service } from '../src/{{kebabCase name}}/{{kebabCase name}}.service'

describe('{{pascalCase name}}Controller', () => {
  let app: express.Application
  let mockService: any

  const mock{{pascalCase name}} = {
    id: 'test-id-1',
{{#each fields}}
    {{name}}: {{mockValue type}},
{{/each}}
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  }

  beforeEach(() => {
    app = express()
    app.use(express.json())
    app.use('/{{pluralize (kebabCase name)}}', {{camelCase name}}Router)

    mockService = new {{pascalCase name}}Service()
    vi.clearAllMocks()
  })

  describe('GET /{{pluralize (kebabCase name)}}', () => {
    it('should return paginated list', async () => {
      mockService.findAll.mockResolvedValue({
        data: [mock{{pascalCase name}}],
        total: 1,
        page: 1,
        limit: 10,
        totalPages: 1,
      })

      const response = await request(app)
        .get('/{{pluralize (kebabCase name)}}')
        .expect(200)

      expect(response.body.data).toHaveLength(1)
      expect(response.body.meta.total).toBe(1)
    })

    it('should accept pagination params', async () => {
      mockService.findAll.mockResolvedValue({
        data: [],
        total: 0,
        page: 2,
        limit: 5,
        totalPages: 0,
      })

      await request(app)
        .get('/{{pluralize (kebabCase name)}}?page=2&limit=5')
        .expect(200)

      expect(mockService.findAll).toHaveBeenCalledWith(
        expect.objectContaining({
          page: 2,
          limit: 5,
        })
      )
    })
  })

  describe('GET /{{pluralize (kebabCase name)}}/:id', () => {
    it('should return {{lowerCase name}} by id', async () => {
      mockService.findById.mockResolvedValue(mock{{pascalCase name}})

      const response = await request(app)
        .get('/{{pluralize (kebabCase name)}}/test-id-1')
        .expect(200)

      expect(response.body.data).toEqual(mock{{pascalCase name}})
    })

    it('should return 404 if not found', async () => {
      mockService.findById.mockResolvedValue(null)

      const response = await request(app)
        .get('/{{pluralize (kebabCase name)}}/non-existent')
        .expect(404)

      expect(response.body.code).toBe('{{constantCase name}}_NOT_FOUND')
    })
  })

  describe('POST /{{pluralize (kebabCase name)}}', () => {
    it('should create new {{lowerCase name}}', async () => {
      const input = {
{{#each fields}}
{{#unless isGenerated}}
        {{name}}: {{mockValue type}},
{{/unless}}
{{/each}}
      }

      mockService.create.mockResolvedValue({ ...mock{{pascalCase name}}, ...input })

      const response = await request(app)
        .post('/{{pluralize (kebabCase name)}}')
        .send(input)
        .expect(201)

      expect(response.body.data).toBeDefined()
    })

    {{#if validation}}
    it('should validate input', async () => {
      const response = await request(app)
        .post('/{{pluralize (kebabCase name)}}')
        .send({})
        .expect(400)

      expect(response.body.code).toBe('VALIDATION_ERROR')
    })
    {{/if}}
  })

  describe('PUT /{{pluralize (kebabCase name)}}/:id', () => {
    it('should update {{lowerCase name}}', async () => {
      const input = {
{{#each fields}}
{{#unless isGenerated}}
        {{name}}: {{mockValue type}},
{{/unless}}
{{/each}}
      }

      mockService.update.mockResolvedValue({ ...mock{{pascalCase name}}, ...input })

      const response = await request(app)
        .put('/{{pluralize (kebabCase name)}}/test-id-1')
        .send(input)
        .expect(200)

      expect(response.body.data).toBeDefined()
    })

    it('should return 404 if not found', async () => {
      mockService.update.mockResolvedValue(null)

      const response = await request(app)
        .put('/{{pluralize (kebabCase name)}}/non-existent')
        .send({})
        .expect(404)

      expect(response.body.code).toBe('{{constantCase name}}_NOT_FOUND')
    })
  })

  describe('DELETE /{{pluralize (kebabCase name)}}/:id', () => {
    it('should delete {{lowerCase name}}', async () => {
      mockService.delete.mockResolvedValue(true)

      await request(app)
        .delete('/{{pluralize (kebabCase name)}}/test-id-1')
        .expect(204)
    })

    it('should return 404 if not found', async () => {
      mockService.delete.mockResolvedValue(false)

      const response = await request(app)
        .delete('/{{pluralize (kebabCase name)}}/non-existent')
        .expect(404)

      expect(response.body.code).toBe('{{constantCase name}}_NOT_FOUND')
    })
  })
})
