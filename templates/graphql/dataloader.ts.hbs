/**
 * {{pascalCase name}} DataLoader
 * Generated by OpenGenerator
 */

import DataLoader from 'dataloader'
import { {{camelCase name}}Repository } from './{{kebabCase name}}.repository'

const repository = new {{camelCase name}}Repository()

/**
 * Create {{pascalCase name}} DataLoader
 * Batches and caches database queries for efficiency
 */
export function create{{pascalCase name}}DataLoader() {
  return new DataLoader<string, {{pascalCase name}} | null>(
    async (ids) => {
      const items = await repository.findMany({
        where: { id: { in: ids as string[] } },
      })

      // Create a map for O(1) lookup
      const itemMap = new Map(items.map((item) => [item.id, item]))

      // Return items in the same order as ids
      return ids.map((id) => itemMap.get(id) || null)
    },
    {
      // Cache for the duration of a single request
      cache: true,
      // Maximum batch size
      maxBatchSize: 100,
    }
  )
}

{{#each relations}}
/**
 * Create {{pascalCase ../name}} {{pascalCase name}} DataLoader
 */
export function create{{pascalCase ../name}}{{pascalCase name}}DataLoader() {
  return new DataLoader<string, {{type}}[]>(
    async ({{camelCase ../name}}Ids) => {
      const items = await {{camelCase type}}Repository.findMany({
        where: { {{../foreignKey}}: { in: {{camelCase ../name}}Ids as string[] } },
      })

      // Group items by parent ID
      const grouped = new Map<string, {{type}}[]>()
      for (const item of items) {
        const parentId = item.{{../foreignKey}}
        if (!grouped.has(parentId)) {
          grouped.set(parentId, [])
        }
        grouped.get(parentId)!.push(item)
      }

      // Return items in the same order as ids
      return {{camelCase ../name}}Ids.map((id) => grouped.get(id) || [])
    },
    {
      cache: true,
      maxBatchSize: 100,
    }
  )
}
{{/each}}

/**
 * Type for {{pascalCase name}} entity
 */
export interface {{pascalCase name}} {
  id: string
{{#each fields}}
  {{name}}: {{type}}
{{/each}}
  createdAt: Date
  updatedAt: Date
}
